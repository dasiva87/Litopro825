# LitoPro 3.0 - SaaS para LitografÃ­as

## Stack & Arquitectura
- **Laravel 12.25.0 + PHP 8.3.21 + Filament 4.0.3 + MySQL**
- **Multi-tenant**: Scopes automÃ¡ticos por `company_id`
- **Frontend**: Livewire 3.6.4 + TailwindCSS 4.1.12

## Comandos Core
```bash
php artisan test                    # Testing completo
php artisan pint && composer analyse    # Lint + anÃ¡lisis
php artisan migrate && php artisan db:seed  # Setup BD
php artisan litopro:setup-demo --fresh     # Demo completo
php artisan litopro:fix-prices --dry-run   # Verificar precios
```

## Convenciones Filament v4

### Namespaces CrÃ­ticos
- **Layout**: `Filament\Schemas\Components\*` (Section, Grid, Tab)
- **Forms**: `Filament\Forms\Components\*` (TextInput, Select, etc.)
- **Actions**: `Filament\Actions\*` (NO Tables\Actions)
- **Columns**: `Filament\Tables\Columns\*`

### Estructura Resources
```
app/Filament/Resources/[Entity]/
â”œâ”€â”€ [Entity]Resource.php
â”œâ”€â”€ Schemas/[Entity]Form.php
â”œâ”€â”€ Tables/[Entity]sTable.php
â””â”€â”€ Pages/
```

### Models Core
- **User**: company_id + Spatie Permission
- **Document**: Cotizaciones polimÃ³rficas
- **SimpleItem/Product/DigitalItem**: Items polimÃ³rficos
- **Contact**: Clientes/proveedores
- **Paper/PrintingMachine**: CatÃ¡logos

## Problemas CrÃ­ticos Resueltos

### MigraciÃ³n Filament v3â†’v4
- **NavigationGroup**: UnitEnum requerido en `app/Enums/NavigationGroup.php`
- **API Migration**: Formâ†’Schema API con `->components([])`
- **Namespaces**: `Filament\Tables\Actions\*` â†’ `Filament\Actions\*`
- **Columns**: `BadgeColumn` â†’ `TextColumn::make()->badge()`

### PatrÃ³n CreateRecord
```php
class CreateQuotation extends CreateRecord {
    protected function mutateFormDataBeforeCreate(array $data): array {
        $data['company_id'] = auth()->user()->company_id;
        $data['user_id'] = auth()->id();
        return $data;
    }
}
```

### Errores Comunes Corregidos
- **PDF Fields**: `$document->number` â†’ `$document->document_number`
- **Price Calculation**: Cast explÃ­cito `(float)` en precios
- **Context Awareness**: Detectar contexto DocumentItem vs SimpleItem
- **MySQL Strict**: `groupByRaw()` para funciones DATE()
- **Auto-generation**: CÃ³digos Ãºnicos en `boot()` method
- **Icon Names**: `heroicon-o-lightning-bolt` â†’ `heroicon-o-bolt`

## Sistema PolimÃ³rfico Items

### Arquitectura Core
```php
class DocumentItem {
    public function itemable(): MorphTo { return $this->morphTo(); }
}

// Items implementados:
// - SimpleItem: CÃ¡lculos automÃ¡ticos con CuttingCalculatorService
// - Product: Inventario con stock y precios
// - DigitalItem: Servicios digitales (unit/size pricing)
// - TalonarioItem: NumeraciÃ³n secuencial + hojas como SimpleItems
```

### SimpleItem - Campos
- **BÃ¡sicos**: description, quantity, horizontal_size, vertical_size
- **Relaciones**: paper_id, printing_machine_id
- **Tintas**: ink_front_count, ink_back_count, front_back_plate
- **Costos**: design_value, transport_value, rifle_value
- **Auto-cÃ¡lculo**: profit_percentage â†’ final_price

### DigitalItem - Tipos de ValoraciÃ³n
```php
// Tipo 'unit': Precio fijo por cantidad
Total = unit_value Ã— quantity

// Tipo 'size': Precio por metro cuadrado  
Total = (width/100 Ã— height/100) Ã— unit_value Ã— quantity
```

### TalonarioItem - Sistema Completo
```php
// NumeraciÃ³n: Prefijo + rango (001-1000)
// Hojas: Cada hoja es SimpleItem independiente
// Acabados: POR_NUMERO / POR_TALONARIO (numeraciÃ³n, perforaciÃ³n, engomado)
// CÃ¡lculo: suma hojas + acabados + costos adicionales
```

## DocumentItems RelationManager

### Funciones Principales
- **"Agregar Item"**: Wizard por tipos (SimpleItem, Product, DigitalItem, TalonarioItem)
- **"Item Sencillo/Producto/Digital RÃ¡pido"**: Modals optimizados
- **Tabla simplificada**: 5 columnas (Tipo, Cantidad, DescripciÃ³n, Precio Unit, Total)
- **Acciones**: Editar, Ver Detalles, Duplicar, Borrar
- **RecÃ¡lculo automÃ¡tico**: Totales actualizados en tiempo real

### Estado Items PolimÃ³rficos
- âœ… **SimpleItem**: CuttingCalculatorService + 6 secciones formulario
- âœ… **Product**: Inventario completo + gestiÃ³n stock + alertas
- âœ… **DigitalItem**: Dual pricing (unit/size) + auto-generaciÃ³n cÃ³digos
- âœ… **TalonarioItem**: NumeraciÃ³n secuencial + hojas mÃºltiples + acabados especÃ­ficos
- ðŸ”„ **MagazineItem**: Pendiente

## Herramientas de Mantenimiento

### Comandos Disponibles
```bash
php artisan litopro:setup-demo --fresh       # Demo completo
php artisan litopro:fix-prices --dry-run     # Verificar precios 0
php artisan litopro:fix-prices               # Corregir automÃ¡tico
```

### MÃ©todos Helper DocumentItem
```php
public function calculateAndUpdatePrices(): bool  // Auto-cÃ¡lculo por tipo
public static function fixZeroPrices(): int       // CorrecciÃ³n masiva
```

## Dashboard Sistema

### Widgets Implementados
- **DashboardStatsWidget**: 6 mÃ©tricas con tendencias (7 dÃ­as)
- **QuickActionsWidget**: 4 categorÃ­as (Documentos, Contactos, ProducciÃ³n, Inventario)
- **ActiveDocumentsWidget**: Tabla documentos activos con filtros
- **StockAlertsWidget**: Alertas crÃ­ticas con costos de reposiciÃ³n
- **DeadlinesWidget**: PrÃ³ximos vencimientos integrados
- **PaperCalculatorWidget**: Canvas HTML5 con visualizaciÃ³n de cortes

### Calculadora de Papel Avanzada
- **TamaÃ±os predefinidos**: Carta, Legal, A4, A3, Tabloide, Custom
- **IntegraciÃ³n inventario**: SelecciÃ³n directa de papeles existentes
- **CÃ¡lculos duales**: OrientaciÃ³n horizontal/vertical automÃ¡tica
- **MÃ©tricas**: Eficiencia, desperdicio, aprovechamiento

### Acceso Demo
```bash
URL: /admin
Usuario: demo@litopro.test / admin@litopro.test
Password: password
```

## Testing & Demo Setup

### Testing Suite (60 tests)
- **Unit Tests**: CuttingCalculatorService (14), SimpleItemCalculatorService (15)
- **Feature Tests**: QuotationWorkflowTest (10), MultiTenantIsolationTest (11)
- **Coverage**: Polimorfismo, multi-tenancy, cÃ¡lculos automÃ¡ticos

### Datos Demo
- **Roles**: Super Admin, Company Admin, Manager, Employee, Client
- **Contenido**: 4 papeles, 3 mÃ¡quinas, 4 productos, 3 contactos
- **CotizaciÃ³n**: COT-2025-DEMO-001 con items mixtos funcional

## PDF System

### Template Mejorado
```php
// Soporte completo polimÃ³rfico
@if($item->itemable_type === 'App\\Models\\SimpleItem')
    {{ $item->itemable->horizontal_size }}Ã—{{ $item->itemable->vertical_size }}cm
@elseif($item->itemable_type === 'App\\Models\\DigitalItem')
    Servicio: {{ $item->itemable->pricing_type === 'unit' ? 'Por unidad' : 'Por mÂ²' }}
@endif
```

### DocumentPdfController
- **Relaciones optimizadas**: `items.itemable` precargado
- **Multi-tenancy**: ValidaciÃ³n automÃ¡tica por company_id

## Lecciones CrÃ­ticas

### Filament v4 Key Points
1. **Resource Pattern**: DelegaciÃ³n a clases Form/Table es obligatoria
2. **CreateRecord Pattern**: Hooks mÃ¡s poderosos que mÃ©todos custom
3. **Widget Properties**: `$view` es de instancia, no static
4. **Context Awareness**: Formularios deben detectar si se llaman desde diferentes contextos

### Multi-tenancy
- **Scopes automÃ¡ticos**: Funcionan correctamente con company_id
- **PDF Security**: Debe respetar restricciones de empresa
- **Aislamiento**: Testing confirma separaciÃ³n total por tenant

### Performance & Debugging
- **Tipo Casting**: Precios deben castearse explÃ­cito a `(float)`
- **Error Boundaries**: Try-catch en consultas complejas previene crashes
- **Dry-run Commands**: Esenciales para verificaciÃ³n antes de operaciones masivas
- **Canvas HTML5**: Visualizaciones interactivas mejoran significativamente UX


## Estado del Sistema
- **Multi-tenancy**: Scopes automÃ¡ticos por company_id
- **PDF Generation**: Template polimÃ³rfico con precios correctos  
- **Dashboard**: 6 widgets + calculadora Canvas HTML5 + alertas stock
- **Testing**: 60 tests (Unit + Feature) + polimorfismo coverage
- **DocumentItems**: RelationManager con wizard + 4 tipos items + recÃ¡lculo automÃ¡tico
- **Price Calculation**: Auto-cÃ¡lculo por tipo + correcciÃ³n masiva + comandos dry-run
- **Roles & Permissions**: Spatie + 5 roles + 28 permisos especÃ­ficos

## PROGRESO RECIENTE

### âœ… TalonarioItem - Sistema Completado (04-Sep-2025)
### âœ… DocumentItemsRelationManager - Optimizado (11-Sep-2025)
**RefactorizaciÃ³n completa con patrÃ³n Strategy:**

#### OptimizaciÃ³n Masiva
- **ReducciÃ³n cÃ³digo**: 4,020 â†’ 403 lÃ­neas (**90% menos**)
- **PatrÃ³n Strategy**: Handlers especializados por tipo de item
- **Factory Pattern**: ItemHandlerFactory para gestiÃ³n centralizada
- **SeparaciÃ³n responsabilidades**: AbstractItemHandler base + handlers especÃ­ficos

#### Arquitectura Mejorada
```
DocumentItemsRelationManager
â”œâ”€â”€ Handlers/
â”‚   â”œâ”€â”€ AbstractItemHandler.php (Base abstracta)
â”‚   â”œâ”€â”€ ItemHandlerFactory.php (Factory pattern)
â”‚   â”œâ”€â”€ MagazineItemHandler.php âœ¨
â”‚   â”œâ”€â”€ SimpleItemHandler.php
â”‚   â”œâ”€â”€ TalonarioItemHandler.php
â”‚   â”œâ”€â”€ DigitalItemHandler.php
â”‚   â””â”€â”€ ProductHandler.php
â””â”€â”€ DocumentItemsRelationManager.php (Orchestrator)
```

#### Problemas Resueltos
- âœ… **MagazineItem ediciÃ³n**: Funcionando correctamente
- âœ… **CÃ³digo duplicado**: Eliminado 90% duplicaciÃ³n
- âœ… **Mantenibilidad**: Extensibilidad mejorada para nuevos tipos
- âœ… **SOLID Principles**: Aplicados correctamente

---

### âœ… TalonarioItem - Sistema Completado (04-Sep-2025)
**ImplementaciÃ³n completa del sistema de talonarios:**

#### Arquitectura Implementada
- **Modelo TalonarioItem**: 270 lÃ­neas con BelongsToTenant + polymorphic relations
- **TalonarioSheet**: Pivot model conectando a SimpleItems
- **TalonarioCalculatorService**: 340+ lÃ­neas con lÃ³gica de negocio completa
- **FinishingMeasurementUnit**: Enum extendido (POR_NUMERO, POR_TALONARIO)

#### CaracterÃ­sticas Funcionales
- **NumeraciÃ³n secuencial**: Prefijo + rango (001-1000) + nÃºmeros por talonario
- **Hojas mÃºltiples**: Cada hoja = SimpleItem con cÃ¡lculos independientes  
- **Acabados especÃ­ficos**: NumeraciÃ³n ($15 por nÃºmero), PerforaciÃ³n ($500 por talonario)
- **Auto-cÃ¡lculos**: Suma hojas + acabados + costos + margen automÃ¡tico
- **Modal "Agregar Hoja"**: Form completo con materiales + tintas + dimensiones

#### Problemas Resueltos
- âœ… **PÃ¡gina en blanco**: Encoding UTF-8 corregido en TalonarioItemForm
- âœ… **Error enum match**: Agregados casos POR_NUMERO/POR_TALONARIO en FinishingsTable
- âœ… **BotÃ³n faltante**: Modal "Agregar Hoja" restaurado con Actions completas  
- âœ… **PrintingCalculation error**: front_back_plate boolean requerido solucionado

#### Archivos Clave Creados/Modificados
```
/database/migrations/2025_09_04_*_talonario_*.php (4 migraciones)
/app/Models/TalonarioItem.php (270 lÃ­neas)
/app/Models/TalonarioSheet.php (122 lÃ­neas)  
/app/Services/TalonarioCalculatorService.php (340+ lÃ­neas)
/app/Filament/Resources/TalonarioItems/* (Resource completo)
/database/seeders/TalonarioFinishingsSeeder.php
```

### ðŸŽ¯ PRÃ“XIMA PRIORIDAD: Sistema de Inventario Avanzado
**Mejorar gestiÃ³n de stock y reportes:**
- Alertas automÃ¡ticas de stock bajo
- Reportes de movimientos de inventario
- IntegraciÃ³n con proveedores para reposiciÃ³n automÃ¡tica
- Dashboard de inventario con mÃ©tricas avanzadas
- Sistema de cÃ³digos de barras/QR para productos

**MagazineItem**: âœ… **COMPLETADO** - Funciona correctamente con handlers optimizados

---

## DocumentaciÃ³n Especializada
- **Testing**: Ver `TESTING_SETUP.md`  
- **Architecture**: Multi-tenant con scopes automÃ¡ticos por company_id

## COMANDO PARA CONTINUAR MAÃ‘ANA
```bash
# Iniciar sesiÃ³n de trabajo
cd /home/dasiva/Descargas/litopro825

# Verificar estado actual
php artisan migrate:status
git status --short
php artisan litopro:setup-demo --fresh  # Si necesitas datos demo

# Servidor desarrollo
php artisan serve

# PrÃ³xima tarea: Sistema de Inventario Avanzado
echo "âœ… MagazineItem completado | ðŸŽ¯ PrÃ³ximo: Sistema Inventario Avanzado"
```